{# get dict of user configurations #}
{%- set git = salt['pillar.get']('tool:git', {}) -%}
{%- set users = salt['defaults.merge'](salt['pillar.get']('tool:users', {}), git.get('users', {}), in_place=False) -%}

{# update all user configuration for git with its defaults #}
{%- do salt['defaults.update'](users, {'git': git.get('defaults', {})}) -%}

{# embed important information #}
{%- for user in users.keys() -%}
  {%- set users[user]['_git'] = {} -%}
  {%- set users[user].name = user -%}
  {%- set user_info = salt['user.info'](user) -%}
  {%- load_yaml as user_info -%}
group: {{ salt['user.primary_group'](user) }}
home: {{ user_info.home }}
shell: {{ user_info.shell.split('/')[-1] }}
  {%- endload -%}
  {%- set users[user] = salt['defaults.merge'](user_info, users[user], in_place=False) -%}

  {%- if users[user].xdg | default('True') -%}
    {#- cannot use environ.get because it only has access to current env, not a specific user's -#}
    {%- load_yaml as xdg -%}
cache: {{ salt['cmd.run']('[ -n "$XDG_CACHE_HOME" ] && echo "${XDG_CACHE_HOME}" || echo "${HOME}/.cache"', runas=user) }}
config: {{ salt['cmd.run']('[ -n "$XDG_CONFIG_HOME" ] && echo "${XDG_CONFIG_HOME}" || echo "${HOME}/.config"', runas=user) }}
data: {{ salt['cmd.run']('[ -n "$XDG_DATA_HOME" ] && echo "${XDG_DATA_HOME}" || echo "${HOME}/.local/share"', runas=user) }}
state: {{ salt['cmd.run']('[ -n "$XDG_STATE_HOME" ] && echo "${XDG_STATE_HOME}" || echo "${HOME}/.local/state"', runas=user) }}
    {%- endload -%}
    {%- set users[user]['xdg'] = xdg -%}
    {%- set users[user]['_git']['confdir'] = xdg.config ~ '/git' -%}
  {%- else -%}
    {%- set users[user]['_git']['confdir'] = user.home -%}
  {%- endif -%}
{%- endfor -%}

{%- set git['users'] = users.values() -%}
